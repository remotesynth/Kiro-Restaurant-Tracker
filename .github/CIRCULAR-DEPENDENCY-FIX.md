# Circular Dependency Fix

This document explains the changes made to fix the circular dependency issue in the CloudFormation template when deploying to LocalStack.

## Problem

When deploying the backend using the `deploy-localstack.sh` script, the following error occurred:

```
2025-07-16T14:00:27.382 ERROR --- [et.reactor-3] l.aws.handlers.logging     : exception during call chain: Circular dependency found.
2025-07-16T14:00:27.382  INFO --- [et.reactor-3] localstack.request.aws     : AWS cloudformation.CreateChangeSet => 500 (InternalError)
```

This error indicates that there was a circular dependency in the CloudFormation template generated by the CDK.

## Root Cause

The circular dependency was caused by how permissions were granted to Lambda functions. In the original code:

1. A common Lambda execution role was created
2. The role was granted permissions to the DynamoDB table
3. Individual Lambda functions were created with this role
4. Each Lambda function was then individually granted permissions to the DynamoDB table

This created a circular reference in the CloudFormation template because:

- The Lambda functions depended on the execution role
- The execution role had permissions that depended on the DynamoDB table
- The DynamoDB table had resource policies that referenced the Lambda functions

## Solution

The solution was to simplify the permission model by:

1. Creating the Lambda execution role first
2. Granting all necessary DynamoDB permissions to this role upfront
3. Using this role for all Lambda functions
4. Removing the individual permission grants to each Lambda function

This breaks the circular dependency by ensuring that:

- The DynamoDB table doesn't have resource policies that directly reference the Lambda functions
- The Lambda functions only depend on the execution role, which has all necessary permissions

## Changes Made

1. Added upfront DynamoDB permission grant to the Lambda execution role:

   ```typescript
   // Grant DynamoDB permissions to Lambda execution role upfront
   table.grantReadWriteData(lambdaExecutionRole);
   ```

2. Removed the duplicate permission grant after creating the Lambda functions:

   ```typescript
   // DynamoDB permissions already granted to Lambda execution role
   ```

3. Removed individual permission grants to restaurant Lambda functions and review Lambda functions

4. Fixed a deprecation warning for S3Origin in the CloudFront distribution by using explicit configuration

## Testing

To test the fix:

1. Run the `test-deploy.sh` script to deploy the stack to LocalStack
2. Verify that the deployment completes successfully without circular dependency errors
3. Run the `e2e-test.sh` script with `USE_LOCALSTACK=true` to test the deployed application

## Additional Improvements

1. Enhanced the `e2e-test.sh` script to better handle LocalStack deployments
2. Added validation to ensure all required values are retrieved from the CloudFormation stack
3. Created a `test-deploy.sh` script to simplify testing the deployment
